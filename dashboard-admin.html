<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Desa Harmoni</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* Base Styles with Glassmorphism */
        :root {
            --primary: #27ae60;
            --primary-light: #2ecc71;
            --primary-dark: #219653;
            --secondary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --darker: #1a252f;
            --light: #ecf0f1;
            --lighter: #f8f9fa;
            --gray: #95a5a6;
            --glass-blur: blur(12px);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4f1fe 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        .container {
            display: flex;
            min-height: 100vh;
            backdrop-filter: blur(2px);
        }

        /* Sidebar Styles with Glassmorphism */
        .sidebar {
            width: 280px;
            background: rgba(44, 62, 80, 0.8);
            color: white;
            transition: all 0.3s ease;
            backdrop-filter: var(--glass-blur);
            border-right: var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .sidebar-header h2 {
            font-weight: 600;
            font-size: 1.3rem;
            background: linear-gradient(to right, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 14px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            margin: 5px 10px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .sidebar-menu li::before {
            content: '';
            position: absolute;
            left: -100%;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }

        .sidebar-menu li:hover::before {
            left: 100%;
        }

        .sidebar-menu li:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu li.active {
            background: linear-gradient(90deg, rgba(39, 174, 96, 0.3), rgba(39, 174, 96, 0.1));
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.2);
        }

        .sidebar-menu li.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary);
        }

        .sidebar-menu li i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: absolute;
            bottom: 0;
            width: 280px;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar with Glassmorphism */
        .top-bar {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: var(--glass-blur);
            border-bottom: var(--glass-border);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 10;
        }

        .search-box {
            position: relative;
            width: 350px;
        }

        .search-box input {
            padding: 10px 20px 10px 45px;
            border-radius: 30px;
            border: none;
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .search-box input:focus {
            outline: none;
            box-shadow: 0 2px 15px rgba(39, 174, 96, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            position: relative;
        }

        .user-info img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
            transition: all 0.3s ease;
        }

        .user-info:hover img {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3);
        }

        .user-info span {
            font-weight: 500;
            color: var(--dark);
        }

        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 10px);
            background: white;
            min-width: 200px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        .user-info:hover .user-dropdown {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-dropdown a {
            display: block;
            padding: 12px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .user-dropdown a:hover {
            background: var(--lighter);
            border-left: 3px solid var(--primary);
            padding-left: 25px;
        }

        .user-dropdown a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Content Section Styles with Glassmorphism */
        .content-section {
            flex: 1;
            padding: 30px;
            display: none;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: var(--glass-blur);
        }

        .content-section.active {
            display: block;
            animation: fadeInContent 0.5s ease;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-section h2 {
            color: var(--dark);
            margin-bottom: 25px;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        .content-section h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 3px;
        }

        /* Card Styles with Glassmorphism */
        .card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(39, 174, 96, 0.15);
        }

        .card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: var(--glass-blur);
            border-radius: 10px;
            overflow: hidden;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        th {
            background-color: rgba(39, 174, 96, 0.1);
            font-weight: 600;
            color: var(--dark);
        }

        tr:hover {
            background-color: rgba(39, 174, 96, 0.05);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Button Styles */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 6px 12px rgba(39, 174, 96, 0.2);
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-success {
            background-color: var(--primary-light);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        /* Announcement Styles */
        .announcement {
            border-left: 4px solid var(--primary);
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .announcement:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .announcement h3 {
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
        }

        .announcement-date {
            color: var(--gray);
            font-size: 0.85em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Stats Card Styles */
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: var(--glass-border);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .stat-card i {
            font-size: 2em;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-card h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--dark);
            font-weight: 700;
        }

        .stat-card p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Utility Classes */
        .d-flex {
            display: flex;
        }

        .flex-column {
            flex-direction: column;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .align-center {
            align-items: center;
        }

        .gap-2 {
            gap: 10px;
        }

        .gap-3 {
            gap: 15px;
        }

        .gap-4 {
            gap: 20px;
        }

        .mb-2 {
            margin-bottom: 10px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        .mb-4 {
            margin-bottom: 20px;
        }

        .mt-2 {
            margin-top: 10px;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .mt-4 {
            margin-top: 20px;
        }

        .text-success {
            color: var(--primary);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-center {
            text-align: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--primary);
        }

        .badge-secondary {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
        }

        .badge-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--primary-light);
        }

        .badge-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        .badge-warning {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
                overflow: hidden;
            }

            .sidebar-header h2,
            .sidebar-menu li span {
                display: none;
            }

            .sidebar-menu li {
                justify-content: center;
                padding: 15px 0;
                margin: 5px;
            }

            .sidebar-menu li i {
                margin-right: 0;
                font-size: 1.3rem;
            }

            .sidebar-footer {
                width: 80px;
                padding: 15px 0;
                display: flex;
                justify-content: center;
            }

            .search-box {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                z-index: 100;
                display: flex;
                border-top: var(--glass-border);
                border-right: none;
            }

            .sidebar-header {
                display: none;
            }

            .sidebar-menu ul {
                display: flex;
                width: 100%;
                justify-content: space-around;
            }

            .sidebar-menu li {
                flex-direction: column;
                padding: 10px 5px;
                font-size: 0.7rem;
                margin: 0;
                border-radius: 0;
            }

            .sidebar-menu li i {
                font-size: 1.2rem;
                margin-bottom: 5px;
            }

            .sidebar-menu li span {
                display: block;
                font-size: 0.7rem;
            }

            .sidebar-menu li.active::after {
                content: '';
                position: absolute;
                right: auto;
                top: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background: var(--primary);
            }

            .sidebar-footer {
                display: none;
            }

            .main-content {
                margin-bottom: 70px;
            }

            .top-bar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .search-box {
                width: 100%;
            }

            .content-section {
                padding: 20px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        /* Animation for cards */
        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-animate {
            animation: cardEntrance 0.5s ease-out forwards;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(39, 174, 96, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
            cursor: pointer;
            z-index: 90;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5);
        }

        /* Admin specific styles */
        .admin-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background-color: rgba(39, 174, 96, 0.1);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .data-table tr:hover {
            background-color: rgba(39, 174, 96, 0.05);
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background-color: var(--secondary);
            color: white;
            border: none;
        }

        .edit-btn:hover {
            background-color: #2980b9;
        }

        .delete-btn {
            background-color: var(--danger);
            color: white;
            border: none;
        }

        .delete-btn:hover {
            background-color: #c0392b;
        }

        .view-btn {
            background-color: var(--primary);
            color: white;
            border: none;
        }

        .view-btn:hover {
            background-color: var(--primary-dark);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 10px;
            margin: 15px 0;
        }

        .progress-bar {
            height: 10px;
            border-radius: 10px;
            background-color: var(--primary);
            text-align: center;
            line-height: 10px;
            color: white;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: right;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="LOGO_KABUPATEN_KEDIRI-removebg-preview.png" width="85" height="100"
                    alt="Kecamatan Papar Logo">
                <h2>Admin Kecamatan Papar</h2>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li class="active" data-section="dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </li>
                    <li data-section="residents">
                        <i class="fas fa-users"></i>
                        <span>Data Warga</span>
                    </li>
                    <li data-section="families">
                        <i class="fas fa-home"></i>
                        <span>Kepala Keluarga</span>
                    </li>
                    <li data-section="announcements">
                        <i class="fas fa-bullhorn"></i>
                        <span>Pengumuman</span>
                    </li>
                    <li data-section="financial">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Keuangan</span>
                    </li>
                    <li data-section="programs">
                        <i class="fas fa-project-diagram"></i>
                        <span>Program Desa</span>
                    </li>
                    <li data-section="complaints">
                        <i class="fas fa-comment-alt"></i>
                        <span>Pengaduan</span>
                    </li>
                    <li data-section="services">
                        <i class="fas fa-tasks"></i>
                        <span>Layanan Warga</span>
                    </li>
                    <li data-section="settings">
                        <i class="fas fa-cog"></i>
                        <span>Pengaturan</span>
                    </li>
                </ul>
            </div>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-danger btn-block">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Keluar</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Cari data warga, pengumuman, atau informasi...">
                </div>
                <div class="user-info">
                    <img src="" alt="User" id="userProfileImage">
                    <span id="userDisplayName">Admin Desa</span>
                    <div class="user-dropdown">
                        <a href="#profile"><i class="fas fa-user"></i> Profil Saya</a>
                        <a href="#settings"><i class="fas fa-cog"></i> Pengaturan</a>
                        <a href="#" id="logoutBtnDropdown"><i class="fas fa-sign-out-alt"></i> Keluar</a>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboardSection">
                <h2>Dashboard Admin Kecamatan Papar</h2>

                <div class="stats-grid">
                    <div class="stat-card card-animate" style="animation-delay: 0.1s;">
                        <i class="fas fa-users"></i>
                        <h3 id="totalResidents">0</h3>
                        <p>Warga Terdaftar</p>
                    </div>
                    <div class="stat-card card-animate" style="animation-delay: 0.2s;">
                        <i class="fas fa-home"></i>
                        <h3 id="totalHouseholds">0</h3>
                        <p>Kepala Keluarga</p>
                    </div>
                    <div class="stat-card card-animate" style="animation-delay: 0.3s;">
                        <i class="fas fa-hand-holding-usd"></i>
                        <h3 id="totalBudget">Rp 0</h3>
                        <p>Anggaran Desa</p>
                    </div>
                    <div class="stat-card card-animate" style="animation-delay: 0.4s;">
                        <i class="fas fa-calendar-check"></i>
                        <h3 id="loadActivePrograms">0</h3>
                        <p>Program Aktif</p>
                    </div>
                </div>

                <div class="card">
                    <h3>Ringkasan Keuangan Desa</h3>
                    <div class="grid">
                        <div class="stat-card">
                            <i class="fas fa-wallet"></i>
                            <h3 id="totalBudget">Rp 0</h3>
                            <p>Total Anggaran</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave"></i>
                            <h3 id="totalExpense">Rp 0</h3>
                            <p>Realisasi</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-piggy-bank"></i>
                            <h3 id="remainingBudget">Rp 0</h3>
                            <p>Sisa Anggaran</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-percentage"></i>
                            <h3 id="realizationPercentage">0%</h3>
                            <p>Terealisasi</p>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="budgetProgress" style="width: 0%"></div>
                        <div class="progress-text" id="budgetProgressText">0% terealisasi</div>
                    </div>
                </div>

                <div class="card">
                    <div class="d-flex justify-between align-center mb-3">
                        <h3>Pengumuman Terbaru</h3>
                        <button class="btn btn-primary" id="addAnnouncementBtn">
                            <i class="fas fa-plus"></i> Tambah Pengumuman
                        </button>
                    </div>
                    <div id="latestAnnouncements">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Residents Section -->
            <div class="content-section" id="residentsSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Data Warga Desa</h2>
                    <button class="btn btn-primary" id="addResidentBtn">
                        <i class="fas fa-plus"></i> Tambah Warga
                    </button>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="search-box" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="residentSearch" placeholder="Cari berdasarkan NIK atau nama...">
                        </div>
                        <select id="residentFilterRT" class="form-group">
                            <option value="">Semua RT</option>
                            <option value="01">RT 01</option>
                            <option value="02">RT 02</option>
                            <option value="03">RT 03</option>
                            <option value="04">RT 04</option>
                            <option value="05">RT 05</option>
                        </select>
                        <select id="residentFilterRW" class="form-group">
                            <option value="">Semua RW</option>
                            <option value="01">RW 01</option>
                            <option value="02">RW 02</option>
                            <option value="03">RW 03</option>
                        </select>
                        <button class="btn btn-secondary" id="exportResidentsBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>NIK</th>
                                    <th>Nama</th>
                                    <th>Alamat</th>
                                    <th>RT/RW</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="residentsList">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="residentCount">0</span> warga ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevResidentsPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextResidentsPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Families Section -->
            <div class="content-section" id="familiesSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Data Kepala Keluarga</h2>
                    <button class="btn btn-primary" id="addFamilyBtn">
                        <i class="fas fa-plus"></i> Tambah KK
                    </button>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="search-box" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="familySearch" placeholder="Cari berdasarkan No. KK atau nama...">
                        </div>
                        <select id="familyFilterRT" class="form-group">
                            <option value="">Semua RT</option>
                            <option value="01">RT 01</option>
                            <option value="02">RT 02</option>
                            <option value="03">RT 03</option>
                            <option value="04">RT 04</option>
                            <option value="05">RT 05</option>
                        </select>
                        <select id="familyFilterRW" class="form-group">
                            <option value="">Semua RW</option>
                            <option value="01">RW 01</option>
                            <option value="02">RW 02</option>
                            <option value="03">RW 03</option>
                        </select>
                        <button class="btn btn-secondary" id="exportFamiliesBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>No. KK</th>
                                    <th>Kepala Keluarga</th>
                                    <th>Alamat</th>
                                    <th>RT/RW</th>
                                    <th>Jumlah Anggota</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="familiesList">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="familyCount">0</span> keluarga ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevFamiliesPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextFamiliesPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Announcements Section -->
            <div class="content-section" id="announcementsSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Pengumuman Kecamatan</h2>
                    <button class="btn btn-primary" id="addAnnouncementBtn">
                        <i class="fas fa-plus"></i> Tambah Pengumuman
                    </button>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="search-box" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="announcementSearch" placeholder="Cari pengumuman...">
                        </div>
                        <select id="announcementFilter" class="form-group">
                            <option value="all">Semua Kategori</option>
                            <option value="general">Umum</option>
                            <option value="event">Kegiatan</option>
                            <option value="important">Penting</option>
                        </select>
                        <select id="announcementSort" class="form-group">
                            <option value="newest">Terbaru</option>
                            <option value="oldest">Terlama</option>
                        </select>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Judul</th>
                                    <th>Isi</th>
                                    <th>Kategori</th>
                                    <th>Tanggal</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsList">
                                <tr>
                                    <td colspan="5" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="announcementCount">0</span> pengumuman ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevAnnouncementsPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextAnnouncementsPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Section -->
            <div class="content-section" id="financialSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Manajemen Keuangan Kecamatan</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="addIncomeBtn">
                            <i class="fas fa-plus"></i> Tambah Penerimaan
                        </button>
                        <button class="btn btn-primary" id="addExpenseBtn">
                            <i class="fas fa-plus"></i> Tambah Pengeluaran
                        </button>
                    </div>
                </div>

                <div class="card mb-4">
                    <h3>Ringkasan Keuangan</h3>
                    <div class="grid">
                        <div class="stat-card">
                            <i class="fas fa-wallet"></i>
                            <h3 id="totalBudget">Rp 0</h3>
                            <p>Total Anggaran</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave"></i>
                            <h3 id="totalExpense">Rp 0</h3>
                            <p>Realisasi</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-piggy-bank"></i>
                            <h3 id="remainingBudget">Rp 0</h3>
                            <p>Sisa Anggaran</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-percentage"></i>
                            <h3 id="realizationPercentage">0%</h3>
                            <p>Terealisasi</p>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="budgetProgress" style="width: 0%"></div>
                        <div class="progress-text" id="budgetProgressText">0% terealisasi</div>
                    </div>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="d-flex gap-2" style="flex: 1;">
                            <select id="financialYear" class="form-group">
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                            </select>
                            <select id="financialMonth" class="form-group">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option>
                                <option value="02">Februari</option>
                                <option value="03">Maret</option>
                                <option value="04">April</option>
                                <option value="05">Mei</option>
                                <option value="06">Juni</option>
                                <option value="07">Juli</option>
                                <option value="08">Agustus</option>
                                <option value="09">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                            <select id="financialType" class="form-group">
                                <option value="all">Semua Jenis</option>
                                <option value="income">Penerimaan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" id="exportFinancialBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                        <button class="btn btn-success" id="generateReportBtn">
                            <i class="fas fa-file-alt"></i> Buat Laporan
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Keterangan</th>
                                    <th>Jenis</th>
                                    <th>Kategori</th>
                                    <th>Jumlah</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="financialTransactions">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="transactionCount">0</span> transaksi ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevTransactionsPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextTransactionsPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Programs Section -->
            <div class="content-section" id="programsSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Program Kecamatan</h2>
                    <button class="btn btn-primary" id="addProgramBtn">
                        <i class="fas fa-plus"></i> Tambah Program
                    </button>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="search-box" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="programSearch" placeholder="Cari program...">
                        </div>
                        <select id="programYear" class="form-group">
                            <option value="all">Semua Tahun</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                        <select id="programStatus" class="form-group">
                            <option value="all">Semua Status</option>
                            <option value="planned">Direncanakan</option>
                            <option value="ongoing">Berjalan</option>
                            <option value="completed">Selesai</option>
                        </select>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nama Program</th>
                                    <th>Kategori</th>
                                    <th>Periode</th>
                                    <th>Anggaran</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="programsList">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="programCount">0</span> program ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevProgramsPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextProgramsPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-section" id="servicesSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Layanan Warga</h2>
                    <div class="d-flex gap-2">
                        <select id="serviceTypeFilter" class="form-group">
                            <option value="all">Semua Jenis</option>
                            <option value="bantuan">Bantuan Sosial</option>
                            <option value="kk">Kartu Keluarga</option>
                            <option value="surat">Surat Keterangan</option>
                            <option value="pengaduan">Pengaduan</option>
                        </select>
                        <select id="serviceStatusFilter" class="form-group">
                            <option value="all">Semua Status</option>
                            <option value="pending">Menunggu</option>
                            <option value="processed">Diproses</option>
                            <option value="completed">Selesai</option>
                            <option value="rejected">Ditolak</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="search-box" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="serviceSearch" placeholder="Cari layanan...">
                        </div>
                        <select id="serviceSort" class="form-group">
                            <option value="newest">Terbaru</option>
                            <option value="oldest">Terlama</option>
                        </select>
                        <button class="btn btn-secondary" id="exportServicesBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Jenis Layanan</th>
                                    <th>Nama Pemohon</th>
                                    <th>NIK</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="servicesList">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="serviceCount">0</span> layanan ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevServicesPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextServicesPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add this modal for service details -->
            <div class="modal" id="serviceModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="serviceModalTitle">Detail Layanan</h3>
                        <button class="modal-close">&times;</button>
                    </div>
                    <div id="serviceDetail">
                        <div class="spinner"></div>
                    </div>
                    <div class="d-flex justify-between mt-4">
                        <button type="button" class="btn btn-secondary modal-close">
                            <i class="fas fa-times"></i> Tutup
                        </button>
                        <div id="serviceActionButtons">
                            <!-- Action buttons will be added here based on status -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Complaints Section -->
            <div class="content-section" id="complaintsSection">
                <div class="d-flex justify-between align-center mb-4">
                    <h2>Pengaduan Warga</h2>
                    <div class="d-flex gap-2">
                        <select id="complaintStatusFilter" class="form-group">
                            <option value="all">Semua Status</option>
                            <option value="pending">Menunggu</option>
                            <option value="processed">Diproses</option>
                            <option value="completed">Selesai</option>
                            <option value="rejected">Ditolak</option>
                        </select>
                        <button class="btn btn-secondary" id="exportComplaintsBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="admin-controls">
                        <div class="search-box" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="complaintSearch" placeholder="Cari pengaduan...">
                        </div>
                        <select id="complaintTypeFilter" class="form-group">
                            <option value="all">Semua Jenis</option>
                            <option value="infrastructure">Infrastruktur</option>
                            <option value="service">Pelayanan</option>
                            <option value="social">Sosial</option>
                            <option value="environment">Lingkungan</option>
                            <option value="other">Lainnya</option>
                        </select>
                        <select id="complaintSort" class="form-group">
                            <option value="newest">Terbaru</option>
                            <option value="oldest">Terlama</option>
                        </select>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Pengadu</th>
                                    <th>Jenis</th>
                                    <th>Isi</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="complaintsList">
                                <tr>
                                    <td colspan="6" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-between mt-4">
                        <div>
                            <span id="complaintCount">0</span> pengaduan ditampilkan
                        </div>
                        <div>
                            <button class="btn btn-outline" id="prevComplaintsPage">
                                <i class="fas fa-chevron-left"></i> Sebelumnya
                            </button>
                            <button class="btn btn-outline" id="nextComplaintsPage">
                                Selanjutnya <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="content-section" id="settingsSection">
                <h2>Pengaturan Sistem</h2>

                <div class="card mb-4">
                    <h3>Informasi Desa</h3>
                    <form id="villageInfoForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="villageName">Nama Kecamatan</label>
                                    <input type="text" id="villageName" required>
                                </div>
                                <div class="form-group">
                                    <label for="villageHead">Nama Kepala Kecamatan</label>
                                    <input type="text" id="villageHead" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="villageAddress">Alamat Kantor Kecamatan</label>
                                    <input type="text" id="villageAddress" required>
                                </div>
                                <div class="form-group">
                                    <label for="villagePhone">Telepon Kecamatan</label>
                                    <input type="tel" id="villagePhone" required>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan Perubahan
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card mb-4">
                    <h3>Anggaran Kecamatan</h3>
                    <form id="budgetForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="budgetYear">Tahun Anggaran</label>
                                    <input type="number" id="budgetYear" min="2000" max="2100" required>
                                </div>
                                <div class="form-group">
                                    <label for="totalBudget">Total Anggaran (Rp)</label>
                                    <input type="number" id="totalBudget" min="0" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="budgetSource">Sumber Anggaran</label>
                                    <input type="text" id="budgetSource" required>
                                </div>
                                <div class="form-group">
                                    <label for="budgetDescription">Keterangan</label>
                                    <textarea id="budgetDescription"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-between">
                            <button type="button" class="btn btn-outline" id="loadBudgetBtn">
                                <i class="fas fa-search"></i> Cari Data
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan Anggaran
                            </button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>Pengguna Admin</h3>
                    <div class="d-flex justify-end mb-3">
                        <button class="btn btn-primary" id="addAdminBtn">
                            <i class="fas fa-plus"></i> Tambah Admin
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Terakhir Login</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersList">
                                <tr>
                                    <td colspan="5" style="text-align: center;">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Resident Modal -->
    <div class="modal" id="residentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="residentModalTitle">Tambah Data Warga</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="residentForm">
                <input type="hidden" id="residentId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="residentNIK">NIK</label>
                            <input type="text" id="residentNIK" required>
                        </div>
                        <div class="form-group">
                            <label for="residentName">Nama Lengkap</label>
                            <input type="text" id="residentName" required>
                        </div>
                        <div class="form-group">
                            <label for="residentBirthplace">Tempat Lahir</label>
                            <input type="text" id="residentBirthplace" required>
                        </div>
                        <div class="form-group">
                            <label for="residentBirthdate">Tanggal Lahir</label>
                            <input type="date" id="residentBirthdate" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="residentGender">Jenis Kelamin</label>
                            <select id="residentGender" required>
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="male">Laki-laki</option>
                                <option value="female">Perempuan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="residentReligion">Agama</label>
                            <select id="residentReligion" required>
                                <option value="">Pilih Agama</option>
                                <option value="islam">Islam</option>
                                <option value="christian">Kristen</option>
                                <option value="catholic">Katolik</option>
                                <option value="hindu">Hindu</option>
                                <option value="buddha">Buddha</option>
                                <option value="konghucu">Konghucu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="residentMaritalStatus">Status Perkawinan</label>
                            <select id="residentMaritalStatus" required>
                                <option value="">Pilih Status</option>
                                <option value="single">Belum Kawin</option>
                                <option value="married">Kawin</option>
                                <option value="divorced">Cerai</option>
                                <option value="widowed">Cerai Mati</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="residentEducation">Pendidikan Terakhir</label>
                            <select id="residentEducation" required>
                                <option value="">Pilih Pendidikan</option>
                                <option value="none">Tidak Sekolah</option>
                                <option value="elementary">SD/Sederajat</option>
                                <option value="junior">SMP/Sederajat</option>
                                <option value="senior">SMA/Sederajat</option>
                                <option value="diploma">D1-D3</option>
                                <option value="bachelor">S1</option>
                                <option value="master">S2</option>
                                <option value="doctorate">S3</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="residentAddress">Alamat</label>
                            <textarea id="residentAddress" required></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="residentRT">RT</label>
                            <select id="residentRT" required>
                                <option value="">Pilih RT</option>
                                <option value="01">RT 01</option>
                                <option value="02">RT 02</option>
                                <option value="03">RT 03</option>
                                <option value="04">RT 04</option>
                                <option value="05">RT 05</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="residentRW">RW</label>
                            <select id="residentRW" required>
                                <option value="">Pilih RW</option>
                                <option value="01">RW 01</option>
                                <option value="02">RW 02</option>
                                <option value="03">RW 03</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="residentPhone">No. HP</label>
                            <input type="tel" id="residentPhone">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="residentJob">Pekerjaan</label>
                            <input type="text" id="residentJob">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="residentFamilyId">Keluarga (No. KK)</label>
                            <select id="residentFamilyId">
                                <option value="">Pilih Keluarga</option>
                                <!-- Will be populated with families -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-secondary modal-close">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Family Modal -->
    <div class="modal" id="familyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="familyModalTitle">Tambah Data Keluarga</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="familyForm">
                <input type="hidden" id="familyId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="familyNumber">Nomor KK</label>
                            <input type="text" id="familyNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="familyHead">Nama Kepala Keluarga</label>
                            <input type="text" id="familyHead" required>
                        </div>
                        <div class="form-group">
                            <label for="familyAddress">Alamat</label>
                            <textarea id="familyAddress" required></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="familyRT">RT</label>
                            <select id="familyRT" required>
                                <option value="">Pilih RT</option>
                                <option value="01">RT 01</option>
                                <option value="02">RT 02</option>
                                <option value="03">RT 03</option>
                                <option value="04">RT 04</option>
                                <option value="05">RT 05</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="familyRW">RW</label>
                            <select id="familyRW" required>
                                <option value="">Pilih RW</option>
                                <option value="01">RW 01</option>
                                <option value="02">RW 02</option>
                                <option value="03">RW 03</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="familyPhone">No. HP</label>
                            <input type="tel" id="familyPhone">
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-secondary modal-close">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan Data
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Announcement Modal -->
    <div class="modal" id="announcementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="announcementModalTitle">Tambah Pengumuman</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="announcementForm">
                <input type="hidden" id="announcementId">
                <div class="form-group">
                    <label for="announcementTitle">Judul Pengumuman</label>
                    <input type="text" id="announcementTitle" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="announcementCategory">Kategori</label>
                            <select id="announcementCategory" required>
                                <option value="">Pilih Kategori</option>
                                <option value="general">Umum</option>
                                <option value="event">Kegiatan</option>
                                <option value="important">Penting</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="announcementDate">Tanggal</label>
                            <input type="date" id="announcementDate" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="announcementContent">Isi Pengumuman</label>
                    <textarea id="announcementContent" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="announcementAttachment">Lampiran (Opsional)</label>
                    <input type="file" id="announcementAttachment">
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-secondary modal-close">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan Pengumuman
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Financial Transaction Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transactionModalTitle">Tambah Transaksi Keuangan</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="transactionType">Jenis Transaksi</label>
                            <select id="transactionType" required>
                                <option value="">Pilih Jenis</option>
                                <option value="income">Penerimaan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">Tanggal</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" min="0" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="transactionCategory">Kategori</label>
                            <select id="transactionCategory" required>
                                <option value="">Pilih Kategori</option>
                                <!-- Will be populated based on transaction type -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionSource">Sumber/Tujuan</label>
                            <input type="text" id="transactionSource" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionDescription">Keterangan</label>
                            <textarea id="transactionDescription" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="transactionReceipt">Bukti Transaksi (Opsional)</label>
                    <input type="file" id="transactionReceipt">
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-secondary modal-close">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan Transaksi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Program Modal -->
    <div class="modal" id="programModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="programModalTitle">Tambah Program Desa</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="programForm">
                <input type="hidden" id="programId">
                <div class="form-group">
                    <label for="programName">Nama Program</label>
                    <input type="text" id="programName" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="programCategory">Kategori</label>
                            <select id="programCategory" required>
                                <option value="">Pilih Kategori</option>
                                <option value="infrastructure">Infrastruktur</option>
                                <option value="social">Sosial</option>
                                <option value="economic">Ekonomi</option>
                                <option value="education">Pendidikan</option>
                                <option value="health">Kesehatan</option>
                                <option value="environment">Lingkungan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="programStartDate">Tanggal Mulai</label>
                            <input type="date" id="programStartDate" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="programBudget">Anggaran (Rp)</label>
                            <input type="number" id="programBudget" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="programEndDate">Tanggal Selesai</label>
                            <input type="date" id="programEndDate" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="programDescription">Deskripsi Program</label>
                    <textarea id="programDescription" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="programTarget">Target Penerima</label>
                    <input type="text" id="programTarget">
                </div>
                <div class="form-group">
                    <label for="programDocument">Dokumen Pendukung (Opsional)</label>
                    <input type="file" id="programDocument">
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-secondary modal-close">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan Program
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Complaint Detail Modal -->
    <div class="modal" id="complaintModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="complaintModalTitle">Detail Pengaduan</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div id="complaintDetail">
                <div class="spinner"></div>
            </div>
            <div class="d-flex justify-between mt-4">
                <button type="button" class="btn btn-secondary modal-close">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <div id="complaintActionButtons">
                    <!-- Action buttons will be added here based on status -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Admin User Modal -->
    <div class="modal" id="adminUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="adminUserModalTitle">Tambah Admin Baru</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="adminUserForm">
                <input type="hidden" id="adminUserId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="adminName">Nama Lengkap</label>
                            <input type="text" id="adminName" required>
                        </div>
                        <div class="form-group">
                            <label for="adminEmail">Email</label>
                            <input type="email" id="adminEmail" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="adminPhone">No. HP</label>
                            <input type="tel" id="adminPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="adminRole">Role</label>
                            <select id="adminRole" required>
                                <option value="admin">Admin</option>
                                <option value="superadmin">Super Admin</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="adminPasswordField">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div class="d-flex justify-between mt-4">
                    <button type="button" class="btn btn-secondary modal-close">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Simpan Admin
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-storage-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEyyQvtGV9UtFFASxhKFhtUu5WaCY-7YM",
            authDomain: "web-menajemen-keuangan.firebaseapp.com",
            databaseURL: "https://web-menajemen-keuangan-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-menajemen-keuangan",
            storageBucket: "web-menajemen-keuangan.appspot.com",
            messagingSenderId: "701529272865",
            appId: "1:701529272865:web:3acaab7a2931905f152960",
            measurementId: "G-G226XMT0TC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const firestore = firebase.firestore();
        const storage = firebase.storage();

        // Current user data
        let currentUser = null;
        let userProfile = null;

        // DOM Elements
        const sections = {
            dashboard: document.getElementById('dashboardSection'),
            residents: document.getElementById('residentsSection'),
            families: document.getElementById('familiesSection'),
            announcements: document.getElementById('announcementsSection'),
            financial: document.getElementById('financialSection'),
            programs: document.getElementById('programsSection'),
            complaints: document.getElementById('complaintsSection'),
            settings: document.getElementById('settingsSection'),
            services: document.getElementById('servicesSection')
        };

        const sidebarLinks = document.querySelectorAll('.sidebar-menu li');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutBtnDropdown = document.getElementById('logoutBtnDropdown');
        const userDisplayName = document.getElementById('userDisplayName');
        const userProfileImage = document.getElementById('userProfileImage');

        // Modals
        const modals = document.querySelectorAll('.modal');
        const modalCloseButtons = document.querySelectorAll('.modal-close');

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            initAuthState();
            initUIEvents();
            initModals();
        });

        // Initialize authentication state listener
        function initAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loadUserProfile(user.uid);
                    updateUIForUser(user);

                    // Load initial data
                    loadDashboardStats();
                    loadLatestAnnouncements();
                } else {
                    // User is signed out
                    window.location.href = 'admin.html';
                }
            });
        }

        // Load user profile from Firestore
        function loadUserProfile(userId) {
            firestore.collection('admins').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        userProfile = doc.data();
                        updateUIForUser(currentUser);

                        // Check if user has admin role
                        if (userProfile.role !== 'admin' && userProfile.role !== 'superadmin') {
                            auth.signOut();
                            alert('Anda tidak memiliki akses ke halaman admin');
                            window.location.href = 'index.html';
                        }
                    } else {
                        console.log("No admin profile found");
                        auth.signOut();
                        window.location.href = 'admin.html';
                    }
                })
                .catch(error => {
                    console.error("Error loading admin profile:", error);
                    auth.signOut();
                    window.location.href = 'admin.html';
                });
        }

        // Update UI based on user authentication state
        function updateUIForUser(user) {
            userDisplayName.textContent = user.displayName || 'Admin Desa';
            if (user.photoURL) {
                userProfileImage.src = user.photoURL;
            }
        }

        // Initialize modal functionality
        function initModals() {
            // Close modals when clicking close button
            modalCloseButtons.forEach(button => {
                button.addEventListener('click', () => {
                    button.closest('.modal').style.display = 'none';
                });
            });

            // Close modals when clicking outside
            modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }

        // Initialize UI event listeners
        function initUIEvents() {
            initServiceFilters();

            // Section switching
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const section = link.getAttribute('data-section');

                    // Update active state
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    // Show selected section
                    Object.values(sections).forEach(sec => sec.classList.remove('active'));
                    if (sections[section]) {
                        sections[section].classList.add('active');


                        // Load section-specific data
                        switch (section) {
                            case 'residents':
                                loadResidents();
                                break;
                            case 'families':
                                loadFamilies();
                                break;
                            case 'announcements':
                                loadAnnouncements();
                                break;
                            case 'financial':
                                loadFinancialTransactions();
                                break;
                            case 'programs':
                                loadPrograms();
                                break;
                            case 'complaints':
                                loadComplaints();
                                break;
                            case 'services':
                                loadServices();
                                break;
                            case 'settings':
                                loadSettings();
                                break;
                        }
                    }
                });
            });

            function initServiceFilters() {
                document.getElementById('serviceTypeFilter').addEventListener('change', loadServices);
                document.getElementById('serviceStatusFilter').addEventListener('change', loadServices);
                document.getElementById('serviceSort').addEventListener('change', loadServices);
                document.getElementById('serviceSearch').addEventListener('input', debounce(loadServices, 300));
            }
            // Logout button
            logoutBtn.addEventListener('click', handleLogout);
            logoutBtnDropdown.addEventListener('click', handleLogout);

            function handleLogout(e) {
                e.preventDefault();
                if (confirm('Apakah Anda yakin ingin keluar?')) {
                    auth.signOut().then(() => {
                        window.location.href = 'index.html';
                    }).catch(error => {
                        console.error("Logout error:", error);
                        alert('Gagal keluar. Silakan coba lagi.');
                    });
                }
            }

            // Add resident button
            document.getElementById('addResidentBtn').addEventListener('click', () => {
                document.getElementById('residentModalTitle').textContent = 'Tambah Data Warga';
                document.getElementById('residentForm').reset();
                document.getElementById('residentId').value = '';
                document.getElementById('residentModal').style.display = 'flex';
            });

            // Add family button
            document.getElementById('addFamilyBtn').addEventListener('click', () => {
                document.getElementById('familyModalTitle').textContent = 'Tambah Data Keluarga';
                document.getElementById('familyForm').reset();
                document.getElementById('familyId').value = '';
                document.getElementById('familyModal').style.display = 'flex';
            });

            // Add announcement button
            document.getElementById('addAnnouncementBtn').addEventListener('click', () => {
                document.getElementById('announcementModalTitle').textContent = 'Tambah Pengumuman';
                document.getElementById('announcementForm').reset();
                document.getElementById('announcementId').value = '';
                document.getElementById('announcementDate').valueAsDate = new Date();
                document.getElementById('announcementModal').style.display = 'flex';
            });

            // Add income button
            document.getElementById('addIncomeBtn').addEventListener('click', () => {
                document.getElementById('transactionModalTitle').textContent = 'Tambah Penerimaan';
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionId').value = '';
                document.getElementById('transactionType').value = 'income';
                document.getElementById('transactionDate').valueAsDate = new Date();
                populateTransactionCategories('income');
                document.getElementById('transactionModal').style.display = 'flex';
            });

            // Add expense button
            document.getElementById('addExpenseBtn').addEventListener('click', () => {
                document.getElementById('transactionModalTitle').textContent = 'Tambah Pengeluaran';
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionId').value = '';
                document.getElementById('transactionType').value = 'expense';
                document.getElementById('transactionDate').valueAsDate = new Date();
                populateTransactionCategories('expense');
                document.getElementById('transactionModal').style.display = 'flex';
            });

            // Add program button
            document.getElementById('addProgramBtn').addEventListener('click', () => {
                document.getElementById('programModalTitle').textContent = 'Tambah Program Desa';
                document.getElementById('programForm').reset();
                document.getElementById('programId').value = '';
                const today = new Date();
                document.getElementById('programStartDate').valueAsDate = today;
                document.getElementById('programEndDate').valueAsDate = new Date(today.setMonth(today.getMonth() + 1));
                document.getElementById('programModal').style.display = 'flex';
            });

            // Add admin user button
            document.getElementById('addAdminBtn').addEventListener('click', () => {
                document.getElementById('adminUserModalTitle').textContent = 'Tambah Admin Baru';
                document.getElementById('adminUserForm').reset();
                document.getElementById('adminUserId').value = '';
                document.getElementById('adminPasswordField').style.display = 'block';
                document.getElementById('adminUserModal').style.display = 'flex';
            });

            // Transaction type change
            document.getElementById('transactionType').addEventListener('change', (e) => {
                populateTransactionCategories(e.target.value);
            });
        }

        // Populate transaction categories based on type
        function populateTransactionCategories(type) {
            const categorySelect = document.getElementById('transactionCategory');
            categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';

            const categories = {
                'income': [
                    'Dana Desa',
                    'Bagi Hasil Pajak',
                    'Bantuan Provinsi',
                    'Bantuan Kabupaten',
                    'Sumbangan',
                    'Lain-lain'
                ],
                'expense': [
                    'Pembangunan Infrastruktur',
                    'Pendidikan',
                    'Kesehatan',
                    'Bantuan Sosial',
                    'Operasional',
                    'Lain-lain'
                ]
            };

            if (type && categories[type]) {
                categories[type].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.toLowerCase().replace(/ /g, '_');
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Fungsi untuk menambah anggaran
        function addBudget(amount) {
            const budgetRef = database.ref('budget');

            budgetRef.transaction(currentData => {
                if (currentData) {
                    currentData.total = (currentData.total || 0) + amount;
                } else {
                    currentData = {
                        total: amount,
                        expense: 0
                    };
                }
                return currentData;
            }).then(() => {
                console.log("Anggaran berhasil ditambah");
            }).catch(error => {
                console.error("Gagal menambah anggaran:", error);
            });
        }

        // Fungsi untuk menambah pengeluaran
        function addExpense(amount) {
            const budgetRef = database.ref('budget');

            budgetRef.transaction(currentData => {
                if (currentData) {
                    currentData.expense = (currentData.expense || 0) + amount;
                } else {
                    currentData = {
                        total: 0,
                        expense: amount
                    };
                }
                return currentData;
            }).then(() => {
                console.log("Pengeluaran berhasil ditambah");
            }).catch(error => {
                console.error("Gagal menambah pengeluaran:", error);
            });
        }

        // Ganti fungsi loadDashboardStats() dengan versi real-time
        function loadDashboardStats() {
            // Load resident count (real-time)
            firestore.collection('residents').onSnapshot(snapshot => {
                document.getElementById('totalResidents').textContent = snapshot.size;
            }, error => {
                console.error("Error loading residents:", error);
                document.getElementById('totalResidents').textContent = "0";
            });

            // Load family count (real-time)
            firestore.collection('families').onSnapshot(snapshot => {
                document.getElementById('totalHouseholds').textContent = snapshot.size;
            }, error => {
                console.error("Error loading families:", error);
                document.getElementById('totalHouseholds').textContent = "0";
            });

            // Load budget data (real-time)
            database.ref('budget').on('value', snapshot => {
                const budgetData = snapshot.val();
                const totalBudget = budgetData?.total || 0;
                const totalExpense = budgetData?.expense || 0;
                const remaining = totalBudget - totalExpense;
                const percentage = totalBudget > 0 ? Math.round((totalExpense / totalBudget) * 100) : 0;

                document.querySelectorAll('#totalBudget').forEach(el => {
                    el.textContent = formatCurrency(totalBudget);
                });

                document.querySelectorAll('#totalExpense').forEach(el => {
                    el.textContent = formatCurrency(totalExpense);
                });

                document.querySelectorAll('#remainingBudget').forEach(el => {
                    el.textContent = formatCurrency(remaining);
                });

                document.getElementById('realizationPercentage').textContent = `${percentage}%`;
                document.getElementById('budgetProgress').style.width = `${percentage}%`;
                document.getElementById('budgetProgressText').textContent = `${percentage}% terealisasi`;
            }, error => {
                console.error("Error loading budget data:", error);
                // Set default values
                document.querySelectorAll('#totalBudget, #totalExpense, #remainingBudget').forEach(el => {
                    el.textContent = formatCurrency(0);
                });
                document.getElementById('realizationPercentage').textContent = "0%";
                document.getElementById('budgetProgress').style.width = "0%";
                document.getElementById('budgetProgressText').textContent = "0% terealisasi";
            });

            // Load active programs count (real-time)
            const now = new Date();
            firestore.collection('programs')
                .where('startDate', '<=', now)
                .where('endDate', '>=', now)
                .onSnapshot(snapshot => {
                    document.getElementById('activePrograms').textContent = snapshot.size;
                }, error => {
                    console.error("Error loading active programs:", error);
                    document.getElementById('activePrograms').textContent = "0";
                });
        }

        // Load latest announcements
        function loadLatestAnnouncements() {
            firestore.collection('announcements')
                .orderBy('date', 'desc')
                .limit(3)
                .get()
                .then(snapshot => {
                    const container = document.getElementById('latestAnnouncements');
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<p>Belum ada pengumuman</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const announcement = doc.data();
                        const announcementElement = createAnnouncementElement(announcement);
                        container.appendChild(announcementElement);
                    });
                });
        }

        // Create announcement element
        function createAnnouncementElement(announcement) {
            const element = document.createElement('div');
            element.className = 'announcement';

            // Format date
            const date = announcement.date?.toDate() || new Date();
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Get category text
            let categoryText = 'Umum';
            if (announcement.category === 'event') categoryText = 'Kegiatan';
            else if (announcement.category === 'important') categoryText = 'Penting';

            element.innerHTML = `
                <h3>${announcement.title}</h3>
                <p class="announcement-date"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
                <p>${announcement.content.substring(0, 150)}...</p>
                <p><strong>Kategori:</strong> <span class="badge badge-primary">${categoryText}</span></p>
            `;

            return element;
        }

        // Load residents data
        function loadResidents() {
            const container = document.getElementById('residentsList');
            container.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            firestore.collection('residents').get()
                .then(snapshot => {
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<tr><td colspan="6">Tidak ada data warga</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const resident = doc.data();
                        const row = createResidentRow(resident, doc.id);
                        container.appendChild(row);
                    });

                    document.getElementById('residentCount').textContent = snapshot.size;
                });
        }

        // Create resident table row
        function createResidentRow(resident, id) {
            const row = document.createElement('tr');

            // Format RT/RW
            const rtRw = resident.rt && resident.rw ? `RT ${resident.rt}/RW ${resident.rw}` : '-';

            row.innerHTML = `
                <td>${resident.nik || '-'}</td>
                <td>${resident.name || '-'}</td>
                <td>${resident.address ? resident.address.substring(0, 30) + '...' : '-'}</td>
                <td>${rtRw}</td>
                <td><span class="badge badge-success">Aktif</span></td>
                <td>
                    <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                </td>
            `;

            // Add event listeners to buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editResident(id));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteResident(id));

            return row;
        }

        // Edit resident
        function editResident(id) {
            firestore.collection('residents').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const resident = doc.data();

                        // Fill the form
                        document.getElementById('residentModalTitle').textContent = 'Edit Data Warga';
                        document.getElementById('residentId').value = id;
                        document.getElementById('residentNIK').value = resident.nik || '';
                        document.getElementById('residentName').value = resident.name || '';
                        document.getElementById('residentBirthplace').value = resident.birthplace || '';
                        document.getElementById('residentBirthdate').value = resident.birthdate || '';
                        document.getElementById('residentGender').value = resident.gender || '';
                        document.getElementById('residentReligion').value = resident.religion || '';
                        document.getElementById('residentMaritalStatus').value = resident.maritalStatus || '';
                        document.getElementById('residentEducation').value = resident.education || '';
                        document.getElementById('residentAddress').value = resident.address || '';
                        document.getElementById('residentRT').value = resident.rt || '';
                        document.getElementById('residentRW').value = resident.rw || '';
                        document.getElementById('residentPhone').value = resident.phone || '';
                        document.getElementById('residentJob').value = resident.job || '';
                        document.getElementById('residentFamilyId').value = resident.familyId || '';

                        // Show the modal
                        document.getElementById('residentModal').style.display = 'flex';
                    }
                });
        }

        // Delete resident
        function deleteResident(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data warga ini?')) {
                firestore.collection('residents').doc(id).delete()
                    .then(() => {
                        alert('Data warga berhasil dihapus');
                        loadResidents();
                    })
                    .catch(error => {
                        console.error("Error deleting resident:", error);
                        alert('Gagal menghapus data warga');
                    });
            }
        }

        // Load families data
        function loadFamilies() {
            const container = document.getElementById('familiesList');
            container.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            firestore.collection('families').get()
                .then(snapshot => {
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<tr><td colspan="6">Tidak ada data keluarga</td></tr>';
                        return;
                    }

                    // First get all families
                    const families = [];
                    snapshot.forEach(doc => {
                        families.push({ id: doc.id, ...doc.data() });
                    });

                    // Then get member counts for each family
                    const promises = families.map(family => {
                        return firestore.collection('residents')
                            .where('familyId', '==', family.id)
                            .get()
                            .then(memberSnapshot => {
                                family.memberCount = memberSnapshot.size;
                                return family;
                            });
                    });

                    Promise.all(promises).then(updatedFamilies => {
                        updatedFamilies.forEach(family => {
                            const row = createFamilyRow(family);
                            container.appendChild(row);
                        });

                        document.getElementById('familyCount').textContent = updatedFamilies.length;
                    });
                });
        }

        // Create family table row
        function createFamilyRow(family) {
            const row = document.createElement('tr');

            // Format RT/RW
            const rtRw = family.rt && family.rw ? `RT ${family.rt}/RW ${family.rw}` : '-';

            row.innerHTML = `
                <td>${family.number || '-'}</td>
                <td>${family.head || '-'}</td>
                <td>${family.address ? family.address.substring(0, 30) + '...' : '-'}</td>
                <td>${rtRw}</td>
                <td>${family.memberCount || 0}</td>
                <td>
                    <button class="action-btn edit-btn" data-id="${family.id}"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" data-id="${family.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;

            // Add event listeners to buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editFamily(family.id));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteFamily(family.id));

            return row;
        }

        // Edit family
        function editFamily(id) {
            firestore.collection('families').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const family = doc.data();

                        // Fill the form
                        document.getElementById('familyModalTitle').textContent = 'Edit Data Keluarga';
                        document.getElementById('familyId').value = id;
                        document.getElementById('familyNumber').value = family.number || '';
                        document.getElementById('familyHead').value = family.head || '';
                        document.getElementById('familyAddress').value = family.address || '';
                        document.getElementById('familyRT').value = family.rt || '';
                        document.getElementById('familyRW').value = family.rw || '';
                        document.getElementById('familyPhone').value = family.phone || '';

                        // Show the modal
                        document.getElementById('familyModal').style.display = 'flex';
                    }
                });
        }

        // Delete family
        function deleteFamily(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data keluarga ini?')) {
                firestore.collection('families').doc(id).delete()
                    .then(() => {
                        alert('Data keluarga berhasil dihapus');
                        loadFamilies();
                    })
                    .catch(error => {
                        console.error("Error deleting family:", error);
                        alert('Gagal menghapus data keluarga');
                    });
            }
        }

        // Load announcements
        function loadAnnouncements() {
            const container = document.getElementById('announcementsList');
            container.innerHTML = '<tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>';

            firestore.collection('announcements')
                .orderBy('date', 'desc')
                .get()
                .then(snapshot => {
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<tr><td colspan="5">Tidak ada pengumuman</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const announcement = doc.data();
                        const row = createAnnouncementRow(announcement, doc.id);
                        container.appendChild(row);
                    });

                    document.getElementById('announcementCount').textContent = snapshot.size;
                });
        }

        // Create announcement table row
        function createAnnouncementRow(announcement, id) {
            const row = document.createElement('tr');

            // Format date
            const date = announcement.date?.toDate() || new Date();
            const formattedDate = date.toLocaleDateString('id-ID');

            // Get category text
            let categoryText = 'Umum';
            if (announcement.category === 'event') categoryText = 'Kegiatan';
            else if (announcement.category === 'important') categoryText = 'Penting';

            row.innerHTML = `
                <td>${announcement.title || '-'}</td>
                <td>${announcement.content ? announcement.content.substring(0, 50) + '...' : '-'}</td>
                <td>${categoryText}</td>
                <td>${formattedDate}</td>
                <td>
                    <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                </td>
            `;

            // Add event listeners to buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editAnnouncement(id));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteAnnouncement(id));

            return row;
        }

        // Edit announcement
        function editAnnouncement(id) {
            firestore.collection('announcements').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const announcement = doc.data();

                        // Fill the form
                        document.getElementById('announcementModalTitle').textContent = 'Edit Pengumuman';
                        document.getElementById('announcementId').value = id;
                        document.getElementById('announcementTitle').value = announcement.title || '';
                        document.getElementById('announcementCategory').value = announcement.category || '';

                        const date = announcement.date?.toDate() || new Date();
                        document.getElementById('announcementDate').valueAsDate = date;

                        document.getElementById('announcementContent').value = announcement.content || '';

                        // Show the modal
                        document.getElementById('announcementModal').style.display = 'flex';
                    }
                });
        }

        // Delete announcement
        function deleteAnnouncement(id) {
            if (confirm('Apakah Anda yakin ingin menghapus pengumuman ini?')) {
                firestore.collection('announcements').doc(id).delete()
                    .then(() => {
                        alert('Pengumuman berhasil dihapus');
                        loadAnnouncements();
                    })
                    .catch(error => {
                        console.error("Error deleting announcement:", error);
                        alert('Gagal menghapus pengumuman');
                    });
            }
        }

        // Load financial transactions
        function loadFinancialTransactions() {
            const container = document.getElementById('financialTransactions');
            container.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            database.ref('transactions').once('value')
                .then(snapshot => {
                    container.innerHTML = '';

                    if (!snapshot.exists()) {
                        container.innerHTML = '<tr><td colspan="6">Tidak ada transaksi</td></tr>';
                        return;
                    }

                    const transactions = [];
                    snapshot.forEach(childSnapshot => {
                        transactions.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });

                    // Sort by date (newest first)
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                    transactions.forEach(transaction => {
                        const row = createTransactionRow(transaction);
                        container.appendChild(row);
                    });

                    document.getElementById('transactionCount').textContent = transactions.length;
                });
        }

        // Create transaction table row
        function createTransactionRow(transaction) {
            const row = document.createElement('tr');

            // Format date
            const date = new Date(transaction.date);
            const formattedDate = date.toLocaleDateString('id-ID');

            // Format amount
            const amountClass = transaction.type === 'income' ? 'text-success' : 'text-danger';
            const amountPrefix = transaction.type === 'income' ? '+' : '-';
            const formattedAmount = `${amountPrefix}${formatCurrency(transaction.amount)}`;

            // Format type
            const typeText = transaction.type === 'income' ? 'Penerimaan' : 'Pengeluaran';

            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${transaction.description || '-'}</td>
                <td>${typeText}</td>
                <td>${transaction.category ? formatCategoryText(transaction.category) : '-'}</td>
                <td class="${amountClass}">${formattedAmount}</td>
                <td>
                    <button class="action-btn edit-btn" data-id="${transaction.id}"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" data-id="${transaction.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;

            // Add event listeners to buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editTransaction(transaction));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteTransaction(transaction.id));

            return row;
        }

        // Format category text
        function formatCategoryText(category) {
            return category.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Edit transaction
        function editTransaction(transaction) {
            // Fill the form
            document.getElementById('transactionModalTitle').textContent = transaction.type === 'income' ?
                'Edit Penerimaan' : 'Edit Pengeluaran';

            document.getElementById('transactionId').value = transaction.id;
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionDate').valueAsDate = new Date(transaction.date);
            document.getElementById('transactionAmount').value = transaction.amount;

            // Populate categories based on type
            populateTransactionCategories(transaction.type);

            // Set category after categories are populated
            setTimeout(() => {
                document.getElementById('transactionCategory').value = transaction.category || '';
            }, 100);

            document.getElementById('transactionSource').value = transaction.source || '';
            document.getElementById('transactionDescription').value = transaction.description || '';

            // Show the modal
            document.getElementById('transactionModal').style.display = 'flex';
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                database.ref('transactions').child(id).remove()
                    .then(() => {
                        alert('Transaksi berhasil dihapus');
                        loadFinancialTransactions();
                    })
                    .catch(error => {
                        console.error("Error deleting transaction:", error);
                        alert('Gagal menghapus transaksi');
                    });
            }
        }

        // Load programs
        function loadPrograms() {
            const container = document.getElementById('programsList');
            container.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            firestore.collection('programs')
                .orderBy('startDate', 'desc')
                .get()
                .then(snapshot => {
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<tr><td colspan="6">Tidak ada program</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const program = doc.data();
                        const row = createProgramRow(program, doc.id);
                        container.appendChild(row);
                    });

                    document.getElementById('programCount').textContent = snapshot.size;
                });
        }

        // Fungsi untuk memuat dan memantau program aktif
        function loadActivePrograms() {
            const now = new Date();
            const programsContainer = document.getElementById('programsList');

            // Set loading state
            programsContainer.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            // Query untuk program aktif (startDate <= now <= endDate)
            const programsQuery = firestore.collection('programs')
                .where('startDate', '<=', now)
                .where('endDate', '>=', now)
                .orderBy('startDate', 'desc');

            // Set up real-time listener
            programsQuery.onSnapshot(snapshot => {
                programsContainer.innerHTML = '';

                if (snapshot.empty) {
                    programsContainer.innerHTML = '<tr><td colspan="6">Tidak ada program aktif</td></tr>';
                    document.getElementById('activePrograms').textContent = '0';
                    return;
                }

                let activeCount = 0;
                snapshot.forEach(doc => {
                    const program = doc.data();
                    const row = createProgramRow(program, doc.id);
                    programsContainer.appendChild(row);
                    activeCount++;
                });

                // Update counter
                document.getElementById('activePrograms').textContent = activeCount;
                document.getElementById('programCount').textContent = activeCount;
            }, error => {
                console.error("Error loading programs:", error);
                programsContainer.innerHTML = '<tr><td colspan="6">Gagal memuat data program</td></tr>';
            });
        }

        // Fungsi pembuat baris tabel program
        function createProgramRow(program, id) {
            const row = document.createElement('tr');

            // Format tanggal
            const startDate = program.startDate?.toDate() || new Date();
            const endDate = program.endDate?.toDate() || new Date();
            const period = `${startDate.toLocaleDateString('id-ID')} - ${endDate.toLocaleDateString('id-ID')}`;

            // Format anggaran
            const formattedBudget = formatCurrency(program.budget || 0);

            // Hitung progress
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const daysPassed = Math.ceil((new Date() - startDate) / (1000 * 60 * 60 * 24));
            const progress = Math.min(100, Math.max(0, Math.round((daysPassed / totalDays) * 100)));

            // Tentukan status
            let statusText, statusClass;
            if (progress >= 100) {
                statusText = 'Selesai';
                statusClass = 'badge-success';
            } else if (progress > 0) {
                statusText = 'Berjalan';
                statusClass = 'badge-primary';
            } else {
                statusText = 'Akan Datang';
                statusClass = 'badge-secondary';
            }

            row.innerHTML = `
        <td>${program.name || '-'}</td>
        <td>${program.category ? formatCategoryText(program.category) : '-'}</td>
        <td>${period}</td>
        <td>${formattedBudget}</td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td>
            <button class="action-btn view-btn" data-id="${id}"><i class="fas fa-eye"></i></button>
            <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
        </td>
    `;

            // Tambahkan event listener
            row.querySelector('.view-btn').addEventListener('click', () => viewProgram(id));
            row.querySelector('.edit-btn').addEventListener('click', () => editProgram(id));

            return row;
        }

        // Create program table row
        function createProgramRow(program, id) {
            const row = document.createElement('tr');

            // Format dates
            const startDate = program.startDate?.toDate() || new Date();
            const endDate = program.endDate?.toDate() || new Date();

            const formattedStartDate = startDate.toLocaleDateString('id-ID');
            const formattedEndDate = endDate.toLocaleDateString('id-ID');
            const period = `${formattedStartDate} - ${formattedEndDate}`;

            // Format budget
            const formattedBudget = formatCurrency(program.budget || 0);

            // Determine status
            const now = new Date();
            let status = 'Direncanakan';
            let statusClass = 'badge-secondary';

            if (startDate <= now && endDate >= now) {
                status = 'Berjalan';
                statusClass = 'badge-primary';
            } else if (endDate < now) {
                status = 'Selesai';
                statusClass = 'badge-success';
            }

            row.innerHTML = `
                <td>${program.name || '-'}</td>
                <td>${program.category ? formatCategoryText(program.category) : '-'}</td>
                <td>${period}</td>
                <td>${formattedBudget}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
                <td>
                    <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                    <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                </td>
            `;

            // Add event listeners to buttons
            row.querySelector('.edit-btn').addEventListener('click', () => editProgram(id));
            row.querySelector('.delete-btn').addEventListener('click', () => deleteProgram(id));

            return row;
        }

        // Edit program
        function editProgram(id) {
            firestore.collection('programs').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const program = doc.data();

                        // Fill the form
                        document.getElementById('programModalTitle').textContent = 'Edit Program Desa';
                        document.getElementById('programId').value = id;
                        document.getElementById('programName').value = program.name || '';
                        document.getElementById('programCategory').value = program.category || '';

                        const startDate = program.startDate?.toDate() || new Date();
                        document.getElementById('programStartDate').valueAsDate = startDate;

                        const endDate = program.endDate?.toDate() || new Date();
                        document.getElementById('programEndDate').valueAsDate = endDate;

                        document.getElementById('programBudget').value = program.budget || '';
                        document.getElementById('programDescription').value = program.description || '';
                        document.getElementById('programTarget').value = program.target || '';

                        // Show the modal
                        document.getElementById('programModal').style.display = 'flex';
                    }
                });
        }

        // Delete program
        function deleteProgram(id) {
            if (confirm('Apakah Anda yakin ingin menghapus program ini?')) {
                firestore.collection('programs').doc(id).delete()
                    .then(() => {
                        alert('Program berhasil dihapus');
                        loadPrograms();
                    })
                    .catch(error => {
                        console.error("Error deleting program:", error);
                        alert('Gagal menghapus program');
                    });
            }
        }

        // Load complaints
        function loadComplaints() {
            const container = document.getElementById('complaintsList');
            container.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            firestore.collection('complaints')
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<tr><td colspan="6">Tidak ada pengaduan</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const complaint = doc.data();
                        const row = createComplaintRow(complaint, doc.id);
                        container.appendChild(row);
                    });

                    document.getElementById('complaintCount').textContent = snapshot.size;
                });
        }

        // Create complaint table row
        function createComplaintRow(complaint, id) {
            const row = document.createElement('tr');

            // Format date
            const date = complaint.createdAt?.toDate() || new Date();
            const formattedDate = date.toLocaleDateString('id-ID');

            // Get type text
            const typeText = getComplaintTypeText(complaint.type);

            // Determine status
            let statusText = 'Menunggu';
            let statusClass = 'badge-secondary';

            if (complaint.status === 'processed') {
                statusText = 'Diproses';
                statusClass = 'badge-primary';
            } else if (complaint.status === 'completed') {
                statusText = 'Selesai';
                statusClass = 'badge-success';
            } else if (complaint.status === 'rejected') {
                statusText = 'Ditolak';
                statusClass = 'badge-danger';
            }

            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${complaint.userName || '-'}</td>
                <td>${typeText}</td>
                <td>${complaint.description ? complaint.description.substring(0, 50) + '...' : '-'}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="action-btn view-btn" data-id="${id}"><i class="fas fa-eye"></i></button>
                </td>
            `;

            // Add event listener to view button
            row.querySelector('.view-btn').addEventListener('click', () => viewComplaint(id));

            return row;
        }

        // Get complaint type text
        function getComplaintTypeText(type) {
            const types = {
                'infrastructure': 'Infrastruktur',
                'service': 'Pelayanan',
                'social': 'Sosial',
                'environment': 'Lingkungan',
                'other': 'Lainnya'
            };

            return types[type] || type;
        }

        // View complaint details
        function viewComplaint(id) {
            firestore.collection('complaints').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const complaint = doc.data();
                        const container = document.getElementById('complaintDetail');

                        // Format date
                        const date = complaint.createdAt?.toDate() || new Date();
                        const formattedDate = date.toLocaleDateString('id-ID', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        // Get type text
                        const typeText = getComplaintTypeText(complaint.type);

                        // Determine status
                        let statusText = 'Menunggu';
                        let statusClass = 'badge-secondary';

                        if (complaint.status === 'processed') {
                            statusText = 'Diproses';
                            statusClass = 'badge-primary';
                        } else if (complaint.status === 'completed') {
                            statusText = 'Selesai';
                            statusClass = 'badge-success';
                        } else if (complaint.status === 'rejected') {
                            statusText = 'Ditolak';
                            statusClass = 'badge-danger';
                        }

                        // Create complaint details HTML
                        let html = `
                            <div class="mb-3">
                                <h4>${complaint.title || 'Tidak ada judul'}</h4>
                                <p class="text-muted"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
                            </div>
                            
                            <div class="mb-3">
                                <p><strong>Pengadu:</strong> ${complaint.userName || '-'}</p>
                                <p><strong>Jenis:</strong> ${typeText}</p>
                                <p><strong>Status:</strong> <span class="badge ${statusClass}">${statusText}</span></p>
                            </div>
                            
                            <div class="mb-3">
                                <h5>Isi Pengaduan</h5>
                                <p>${complaint.description || 'Tidak ada deskripsi'}</p>
                            </div>
                        `;

                        // Add proof if exists
                        if (complaint.proofUrl) {
                            html += `
                                <div class="mb-3">
                                    <h5>Bukti Pendukung</h5>
                                    <img src="${complaint.proofUrl}" alt="Bukti pengaduan" style="max-width: 100%; max-height: 200px;">
                                </div>
                            `;
                        }

                        // Add response if exists
                        if (complaint.response) {
                            html += `
                                <div class="mb-3">
                                    <h5>Tanggapan</h5>
                                    <p>${complaint.response}</p>
                                    <p class="text-muted"><small>
                                        <i class="far fa-calendar-alt"></i> 
                                        ${complaint.respondedAt?.toDate().toLocaleDateString('id-ID') || ''}
                                    </small></p>
                                </div>
                            `;
                        }

                        container.innerHTML = html;

                        // Create action buttons based on status
                        const actionButtons = document.getElementById('complaintActionButtons');
                        actionButtons.innerHTML = '';

                        if (complaint.status === 'pending') {
                            const processBtn = document.createElement('button');
                            processBtn.className = 'btn btn-primary';
                            processBtn.innerHTML = '<i class="fas fa-check"></i> Proses Pengaduan';
                            processBtn.addEventListener('click', () => updateComplaintStatus(id, 'processed'));
                            actionButtons.appendChild(processBtn);

                            const rejectBtn = document.createElement('button');
                            rejectBtn.className = 'btn btn-danger';
                            rejectBtn.innerHTML = '<i class="fas fa-times"></i> Tolak Pengaduan';
                            rejectBtn.addEventListener('click', () => updateComplaintStatus(id, 'rejected'));
                            actionButtons.appendChild(rejectBtn);
                        } else if (complaint.status === 'processed') {
                            const completeBtn = document.createElement('button');
                            completeBtn.className = 'btn btn-success';
                            completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> Tandai Selesai';
                            completeBtn.addEventListener('click', () => updateComplaintStatus(id, 'completed'));
                            actionButtons.appendChild(completeBtn);
                        }

                        // Show the modal
                        document.getElementById('complaintModal').style.display = 'flex';
                    }
                });
        }

        // Update complaint status
        function updateComplaintStatus(id, status) {
            const updateData = {
                status: status,
                respondedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (status === 'processed') {
                if (!confirm('Apakah Anda yakin ingin memproses pengaduan ini?')) return;
            } else if (status === 'rejected') {
                const response = prompt('Masukkan alasan penolakan:');
                if (!response) return;
                updateData.response = response;
            } else if (status === 'completed') {
                const response = prompt('Masukkan tanggapan penyelesaian:');
                if (!response) return;
                updateData.response = response;
            }

            firestore.collection('complaints').doc(id).update(updateData)
                .then(() => {
                    alert('Status pengaduan berhasil diperbarui');
                    document.getElementById('complaintModal').style.display = 'none';
                    loadComplaints();
                })
                .catch(error => {
                    console.error("Error updating complaint:", error);
                    alert('Gagal memperbarui status pengaduan');
                });
        }

        // Load settings
        function loadSettings() {
            // Load village info
            database.ref('villageInfo').once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const villageInfo = snapshot.val();
                        document.getElementById('villageName').value = villageInfo.name || '';
                        document.getElementById('villageHead').value = villageInfo.head || '';
                        document.getElementById('villageAddress').value = villageInfo.address || '';
                        document.getElementById('villagePhone').value = villageInfo.phone || '';
                    }
                });

            // Load current budget
            const currentYear = new Date().getFullYear();
            document.getElementById('budgetYear').value = currentYear;
            loadBudgetData(currentYear);

            // Load admin users
            loadAdminUsers();
        }

        // Load budget data
        function loadBudgetData(year) {
            firestore.collection('budgets')
                .where('year', '==', parseInt(year))
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const budgetData = snapshot.docs[0].data();
                        document.getElementById('totalBudget').value = budgetData.amount || '';
                        document.getElementById('budgetSource').value = budgetData.source || '';
                        document.getElementById('budgetDescription').value = budgetData.description || '';
                    } else {
                        document.getElementById('totalBudget').value = '';
                        document.getElementById('budgetSource').value = '';
                        document.getElementById('budgetDescription').value = '';
                    }
                });
        }

        // Load admin users
        function loadAdminUsers() {
            const container = document.getElementById('adminUsersList');
            container.innerHTML = '<tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>';

            firestore.collection('adminUsers').get()
                .then(snapshot => {
                    container.innerHTML = '';

                    if (snapshot.empty) {
                        container.innerHTML = '<tr><td colspan="5">Tidak ada admin</td></tr>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const admin = doc.data();
                        const row = createAdminUserRow(admin, doc.id);
                        container.appendChild(row);
                    });
                });
        }

        // Create admin user table row
        function createAdminUserRow(admin, id) {
            const row = document.createElement('tr');

            // Format last login
            let lastLogin = '-';
            if (admin.lastLogin) {
                const loginDate = admin.lastLogin.toDate();
                lastLogin = loginDate.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Determine status
            const isCurrentUser = id === currentUser.uid;
            const statusText = isCurrentUser ? 'Anda' : (admin.status === 'active' ? 'Aktif' : 'Nonaktif');
            const statusClass = isCurrentUser ? 'badge-primary' : (admin.status === 'active' ? 'badge-success' : 'badge-secondary');

            row.innerHTML = `
                <td>${admin.name || '-'}</td>
                <td>${admin.email || '-'}</td>
                <td>${lastLogin}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>
                    ${isCurrentUser ? '' : `
                        <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                    `}
                </td>
            `;

            // Add event listeners to buttons if not current user
            if (!isCurrentUser) {
                row.querySelector('.edit-btn').addEventListener('click', () => editAdminUser(id));
                row.querySelector('.delete-btn').addEventListener('click', () => deleteAdminUser(id));
            }

            return row;
        }

        // Edit admin user
        function editAdminUser(id) {
            firestore.collection('adminUsers').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const admin = doc.data();

                        // Fill the form
                        document.getElementById('adminUserModalTitle').textContent = 'Edit Admin';
                        document.getElementById('adminUserId').value = id;
                        document.getElementById('adminName').value = admin.name || '';
                        document.getElementById('adminEmail').value = admin.email || '';
                        document.getElementById('adminPhone').value = admin.phone || '';
                        document.getElementById('adminRole').value = admin.role || 'admin';
                        document.getElementById('adminPasswordField').style.display = 'none';

                        // Show the modal
                        document.getElementById('adminUserModal').style.display = 'flex';
                    }
                });
        }

        // Delete admin user
        function deleteAdminUser(id) {
            if (confirm('Apakah Anda yakin ingin menghapus admin ini?')) {
                firestore.collection('adminUsers').doc(id).delete()
                    .then(() => {
                        alert('Admin berhasil dihapus');
                        loadAdminUsers();
                    })
                    .catch(error => {
                        console.error("Error deleting admin:", error);
                        alert('Gagal menghapus admin');
                    });
            }
        }

        function formatCurrency(amount) {
            if (isNaN(amount)) amount = 0;
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(amount);
        }

        // Form submissions
        document.getElementById('residentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const residentId = document.getElementById('residentId').value;
            const residentData = {
                nik: document.getElementById('residentNIK').value,
                name: document.getElementById('residentName').value,
                birthplace: document.getElementById('residentBirthplace').value,
                birthdate: document.getElementById('residentBirthdate').value,
                gender: document.getElementById('residentGender').value,
                religion: document.getElementById('residentReligion').value,
                maritalStatus: document.getElementById('residentMaritalStatus').value,
                education: document.getElementById('residentEducation').value,
                address: document.getElementById('residentAddress').value,
                rt: document.getElementById('residentRT').value,
                rw: document.getElementById('residentRW').value,
                phone: document.getElementById('residentPhone').value,
                job: document.getElementById('residentJob').value,
                familyId: document.getElementById('residentFamilyId').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (residentId) {
                // Update existing resident
                firestore.collection('residents').doc(residentId).update(residentData)
                    .then(() => {
                        alert('Data warga berhasil diperbarui');
                        document.getElementById('residentModal').style.display = 'none';
                        loadResidents();
                    })
                    .catch(error => {
                        console.error("Error updating resident:", error);
                        alert('Gagal memperbarui data warga');
                    });
            } else {
                // Add new resident
                residentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                residentData.status = 'active';

                firestore.collection('residents').add(residentData)
                    .then(() => {
                        alert('Data warga berhasil ditambahkan');
                        document.getElementById('residentModal').style.display = 'none';
                        loadResidents();
                    })
                    .catch(error => {
                        console.error("Error adding resident:", error);
                        alert('Gagal menambahkan data warga');
                    });
            }
        });

        document.getElementById('familyForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const familyId = document.getElementById('familyId').value;
            const familyData = {
                number: document.getElementById('familyNumber').value,
                head: document.getElementById('familyHead').value,
                address: document.getElementById('familyAddress').value,
                rt: document.getElementById('familyRT').value,
                rw: document.getElementById('familyRW').value,
                phone: document.getElementById('familyPhone').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (familyId) {
                // Update existing family
                firestore.collection('families').doc(familyId).update(familyData)
                    .then(() => {
                        alert('Data keluarga berhasil diperbarui');
                        document.getElementById('familyModal').style.display = 'none';
                        loadFamilies();
                    })
                    .catch(error => {
                        console.error("Error updating family:", error);
                        alert('Gagal memperbarui data keluarga');
                    });
            } else {
                // Add new family
                familyData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                familyData.status = 'active';

                firestore.collection('families').add(familyData)
                    .then(() => {
                        alert('Data keluarga berhasil ditambahkan');
                        document.getElementById('familyModal').style.display = 'none';
                        loadFamilies();
                    })
                    .catch(error => {
                        console.error("Error adding family:", error);
                        alert('Gagal menambahkan data keluarga');
                    });
            }
        });

        document.getElementById('announcementForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const announcementId = document.getElementById('announcementId').value;
            const announcementData = {
                title: document.getElementById('announcementTitle').value,
                category: document.getElementById('announcementCategory').value,
                date: new Date(document.getElementById('announcementDate').value),
                content: document.getElementById('announcementContent').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (announcementId) {
                // Update existing announcement
                firestore.collection('announcements').doc(announcementId).update(announcementData)
                    .then(() => {
                        alert('Pengumuman berhasil diperbarui');
                        document.getElementById('announcementModal').style.display = 'none';
                        loadAnnouncements();
                        loadLatestAnnouncements();
                    })
                    .catch(error => {
                        console.error("Error updating announcement:", error);
                        alert('Gagal memperbarui pengumuman');
                    });
            } else {
                // Add new announcement
                announcementData.createdAt = firebase.firestore.FieldValue.serverTimestamp();

                firestore.collection('announcements').add(announcementData)
                    .then(() => {
                        alert('Pengumuman berhasil ditambahkan');
                        document.getElementById('announcementModal').style.display = 'none';
                        loadAnnouncements();
                        loadLatestAnnouncements();
                    })
                    .catch(error => {
                        console.error("Error adding announcement:", error);
                        alert('Gagal menambahkan pengumuman');
                    });
            }
        });

        document.getElementById('transactionForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const transactionId = document.getElementById('transactionId').value;
            const transactionType = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);

            const transactionData = {
                type: transactionType,
                date: document.getElementById('transactionDate').value,
                amount: amount,
                category: document.getElementById('transactionCategory').value,
                source: document.getElementById('transactionSource').value,
                description: document.getElementById('transactionDescription').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (transactionId) {
                // Update existing transaction (lebih kompleks, perlu hitung selisih)
                // Implementasi bisa ditambahkan sesuai kebutuhan
            } else {
                // Add new transaction
                transactionData.createdAt = firebase.firestore.FieldValue.serverTimestamp();

                // Simpan transaksi
                database.ref('transactions').push(transactionData)
                    .then(() => {
                        // Update anggaran berdasarkan jenis transaksi
                        if (transactionType === 'income') {
                            addBudget(amount);
                        } else if (transactionType === 'expense') {
                            addExpense(amount);
                        }

                        alert('Transaksi berhasil ditambahkan');
                        document.getElementById('transactionModal').style.display = 'none';
                    })
                    .catch(error => {
                        console.error("Error adding transaction:", error);
                        alert('Gagal menambahkan transaksi');
                    });
            }
        });

        document.getElementById('programForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const programId = document.getElementById('programId').value;
            const programData = {
                name: document.getElementById('programName').value,
                category: document.getElementById('programCategory').value,
                startDate: new Date(document.getElementById('programStartDate').value),
                endDate: new Date(document.getElementById('programEndDate').value),
                budget: parseFloat(document.getElementById('programBudget').value),
                description: document.getElementById('programDescription').value,
                target: document.getElementById('programTarget').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (programId) {
                // Update existing program
                firestore.collection('programs').doc(programId).update(programData)
                    .then(() => {
                        alert('Program berhasil diperbarui');
                        document.getElementById('programModal').style.display = 'none';
                        loadPrograms();
                        loadDashboardStats();
                    })
                    .catch(error => {
                        console.error("Error updating program:", error);
                        alert('Gagal memperbarui program');
                    });
            } else {
                // Add new program
                programData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                programData.status = 'planned';

                firestore.collection('programs').add(programData)
                    .then(() => {
                        alert('Program berhasil ditambahkan');
                        document.getElementById('programModal').style.display = 'none';
                        loadPrograms();
                        loadDashboardStats();
                    })
                    .catch(error => {
                        console.error("Error adding program:", error);
                        alert('Gagal menambahkan program');
                    });
            }
        });

        document.getElementById('villageInfoForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const villageInfo = {
                name: document.getElementById('villageName').value,
                head: document.getElementById('villageHead').value,
                address: document.getElementById('villageAddress').value,
                phone: document.getElementById('villagePhone').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            database.ref('villageInfo').set(villageInfo)
                .then(() => {
                    alert('Informasi desa berhasil diperbarui');
                })
                .catch(error => {
                    console.error("Error updating village info:", error);
                    alert('Gagal memperbarui informasi desa');
                });
        });

        document.getElementById('budgetForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const year = parseInt(document.getElementById('budgetYear').value);
            const budgetData = {
                year: year,
                amount: parseFloat(document.getElementById('totalBudget').value),
                source: document.getElementById('budgetSource').value,
                description: document.getElementById('budgetDescription').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Check if budget for this year already exists
            firestore.collection('budgets')
                .where('year', '==', year)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        // Update existing budget
                        const docId = snapshot.docs[0].id;
                        return firestore.collection('budgets').doc(docId).update(budgetData);
                    } else {
                        // Add new budget
                        budgetData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        return firestore.collection('budgets').add(budgetData);
                    }
                })
                .then(() => {
                    alert('Anggaran berhasil disimpan');
                    // Update database budget reference
                    return database.ref('budget').update({
                        total: budgetData.amount,
                        expense: 0
                    });
                })
                .then(() => {
                    loadDashboardStats();
                })
                .catch(error => {
                    console.error("Error saving budget:", error);
                    alert('Gagal menyimpan anggaran');
                });
        });

        document.getElementById('loadBudgetBtn').addEventListener('click', function () {
            const year = parseInt(document.getElementById('budgetYear').value);
            loadBudgetData(year);
        });

        document.getElementById('adminUserForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const adminId = document.getElementById('adminUserId').value;
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const adminData = {
                name: document.getElementById('adminName').value,
                email: email,
                phone: document.getElementById('adminPhone').value,
                role: document.getElementById('adminRole').value,
                status: 'active',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (adminId) {
                // Update existing admin
                firestore.collection('adminUsers').doc(adminId).update(adminData)
                    .then(() => {
                        alert('Admin berhasil diperbarui');
                        document.getElementById('adminUserModal').style.display = 'none';
                        loadAdminUsers();
                    })
                    .catch(error => {
                        console.error("Error updating admin:", error);
                        alert('Gagal memperbarui admin');
                    });
            } else {
                // Create new admin user
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;

                        // Set display name
                        return user.updateProfile({
                            displayName: adminData.name
                        }).then(() => {
                            // Save admin data
                            adminData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            adminData.uid = user.uid;

                            return firestore.collection('adminUsers').doc(user.uid).set(adminData);
                        });
                    })
                    .then(() => {
                        alert('Admin baru berhasil ditambahkan');
                        document.getElementById('adminUserModal').style.display = 'none';
                        loadAdminUsers();
                    })
                    .catch(error => {
                        console.error("Error adding admin:", error);
                        alert('Gagal menambahkan admin');
                    });
            }
        });

        // Fungsi untuk memantau program aktif
        function monitorActivePrograms() {
            const now = new Date();

            // Listener untuk program yang aktif (berjalan saat ini)
            firestore.collection('programs')
                .where('startDate', '<=', now)
                .where('endDate', '>=', now)
                .onSnapshot(snapshot => {
                    document.getElementById('activePrograms').textContent = snapshot.size;

                    // Hitung total anggaran program aktif
                    let totalBudget = 0;
                    snapshot.forEach(doc => {
                        totalBudget += doc.data().budget || 0;
                    });

                    document.getElementById('programsTotalBudget').textContent = formatCurrency(totalBudget);
                }, error => {
                    console.error("Error loading active programs:", error);
                    document.getElementById('activePrograms').textContent = "0";
                    document.getElementById('programsTotalBudget').textContent = formatCurrency(0);
                });
        }

        // Panggil fungsi ini saat inisialisasi
        monitorActivePrograms();

        // Add this to the initUIEvents function
        document.getElementById('serviceTypeFilter').addEventListener('change', loadServices);
        document.getElementById('serviceStatusFilter').addEventListener('change', loadServices);
        document.getElementById('serviceSort').addEventListener('change', loadServices);
        document.getElementById('serviceSearch').addEventListener('input', loadServices);

        // Add this function to load services
        function loadServices() {
            const container = document.getElementById('servicesList');
            container.innerHTML = '<tr><td colspan="6" style="text-align: center;"><div class="spinner"></div></td></tr>';

            const typeFilter = document.getElementById('serviceTypeFilter').value;
            const statusFilter = document.getElementById('serviceStatusFilter').value;
            const sortOrder = document.getElementById('serviceSort').value;
            const searchQuery = document.getElementById('serviceSearch').value.toLowerCase();

            // Inisialisasi array untuk semua layanan
            let allServices = [];

            // Fungsi untuk menangani setiap jenis layanan
            const handleServiceLoad = (serviceType, serviceData) => {
                return {
                    id: serviceData.id,
                    type: serviceType,
                    typeText: getServiceTypeText(serviceType),
                    name: serviceData.nama || serviceData.nama_kepala_keluarga || 'Anonim',
                    nik: serviceData.nik || serviceData.no_kk || '-',
                    timestamp: serviceData.timestamp || serviceData.tanggal_pengajuan || new Date().toISOString(),
                    status: serviceData.status || 'pending',
                    data: serviceData
                };
            };

            // Load data dari Firebase
            const loadPromises = [];

            if (typeFilter === 'all' || typeFilter === 'bantuan') {
                loadPromises.push(
                    database.ref('bantuan_sosial').once('value').then(snapshot => {
                        snapshot.forEach(child => {
                            allServices.push(handleServiceLoad('bantuan', { id: child.key, ...child.val() }));
                        });
                    })
                );
            }

            if (typeFilter === 'all' || typeFilter === 'kk') {
                loadPromises.push(
                    database.ref('kartu_keluarga').once('value').then(snapshot => {
                        snapshot.forEach(child => {
                            allServices.push(handleServiceLoad('kk', { id: child.key, ...child.val() }));
                        });
                    })
                );
            }

            if (typeFilter === 'all' || typeFilter === 'surat') {
                loadPromises.push(
                    database.ref('surat_keterangan').once('value').then(snapshot => {
                        snapshot.forEach(child => {
                            allServices.push(handleServiceLoad('surat', { id: child.key, ...child.val() }));
                        });
                    })
                );
            }

            if (typeFilter === 'all' || typeFilter === 'pengaduan') {
                loadPromises.push(
                    database.ref('pengaduan').once('value').then(snapshot => {
                        snapshot.forEach(child => {
                            allServices.push(handleServiceLoad('pengaduan', { id: child.key, ...child.val() }));
                        });
                    })
                );
            }

            Promise.all(loadPromises).then(() => {
                // Filter data
                const filteredServices = allServices.filter(service => {
                    // Filter status
                    if (statusFilter !== 'all' && service.status !== statusFilter) {
                        return false;
                    }

                    // Filter pencarian
                    if (searchQuery) {
                        const searchStr = `${service.name} ${service.nik} ${service.typeText}`.toLowerCase();
                        if (!searchStr.includes(searchQuery)) {
                            return false;
                        }
                    }

                    return true;
                });

                // Sort data
                filteredServices.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                });

                // Tampilkan data
                container.innerHTML = '';
                if (filteredServices.length === 0) {
                    container.innerHTML = '<tr><td colspan="6">Tidak ada data layanan</td></tr>';
                } else {
                    filteredServices.forEach(service => {
                        container.appendChild(createServiceRow(service));
                    });
                }

                document.getElementById('serviceCount').textContent = filteredServices.length;
            }).catch(error => {
                console.error("Error loading services:", error);
                container.innerHTML = '<tr><td colspan="6">Gagal memuat data layanan</td></tr>';
            });
        }

        function getServiceTypeText(type) {
            const types = {
                'bantuan': 'Bantuan Sosial',
                'kk': 'Kartu Keluarga',
                'surat': 'Surat Keterangan',
                'pengaduan': 'Pengaduan'
            };
            return types[type] || type;
        }

        function loadBantuanSosial() {
            return new Promise((resolve) => {
                database.ref('bantuan_sosial').once('value').then(snapshot => {
                    const services = [];

                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        services.push({
                            id: childSnapshot.key,
                            type: 'bantuan',
                            typeText: 'Bantuan Sosial',
                            name: data.nama,
                            nik: data.nik,
                            timestamp: data.timestamp,
                            status: data.status || 'pending',
                            data: data
                        });
                    });

                    resolve(services);
                });
            });
        }

        function loadKartuKeluarga() {
            return new Promise((resolve) => {
                database.ref('kartu_keluarga').once('value').then(snapshot => {
                    const services = [];

                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        services.push({
                            id: childSnapshot.key,
                            type: 'kk',
                            typeText: 'Kartu Keluarga',
                            name: data.nama_kepala_keluarga,
                            nik: data.no_kk,
                            timestamp: data.tanggal_pengajuan,
                            status: data.status || 'pending',
                            data: data
                        });
                    });

                    resolve(services);
                });
            });
        }

        function loadSuratKeterangan() {
            return new Promise((resolve) => {
                database.ref('surat_keterangan').once('value').then(snapshot => {
                    const services = [];

                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        services.push({
                            id: childSnapshot.key,
                            type: 'surat',
                            typeText: 'Surat Keterangan',
                            name: data.data_pemohon.nama,
                            nik: data.data_pemohon.nik,
                            timestamp: data.tanggal_pengajuan,
                            status: data.status || 'pending',
                            data: data
                        });
                    });

                    resolve(services);
                });
            });
        }

        function loadPengaduan() {
            return new Promise((resolve) => {
                database.ref('pengaduan').once('value').then(snapshot => {
                    const services = [];

                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        services.push({
                            id: childSnapshot.key,
                            type: 'pengaduan',
                            typeText: 'Pengaduan',
                            name: data.nama || 'Anonim',
                            nik: data.nik || '-',
                            timestamp: data.timestamp,
                            status: data.status || 'pending',
                            data: data
                        });
                    });

                    resolve(services);
                });
            });
        }

        function createServiceRow(service) {
            const row = document.createElement('tr');

            // Format tanggal
            const date = new Date(service.timestamp);
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });

            // Format status
            let statusClass, statusText;
            switch (service.status) {
                case 'pending':
                    statusClass = 'badge-secondary';
                    statusText = 'Menunggu';
                    break;
                case 'processed':
                    statusClass = 'badge-primary';
                    statusText = 'Diproses';
                    break;
                case 'completed':
                    statusClass = 'badge-success';
                    statusText = 'Selesai';
                    break;
                case 'rejected':
                    statusClass = 'badge-danger';
                    statusText = 'Ditolak';
                    break;
                default:
                    statusClass = 'badge-warning';
                    statusText = service.status;
            }

            row.innerHTML = `
        <td>${formattedDate}</td>
        <td>${service.typeText}</td>
        <td>${service.name}</td>
        <td>${service.nik}</td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td>
            <button class="action-btn view-btn" data-id="${service.id}" data-type="${service.type}">
                <i class="fas fa-eye"></i> Lihat
            </button>
        </td>
    `;

            // Tambahkan event listener untuk tombol lihat
            row.querySelector('.view-btn').addEventListener('click', () => viewServiceDetail(service));

            return row;
        }

        function viewServiceDetail(service) {
            const modal = document.getElementById('serviceModal');
            const modalTitle = document.getElementById('serviceModalTitle');
            const modalContent = document.getElementById('serviceDetail');
            const actionButtons = document.getElementById('serviceActionButtons');

            modalTitle.textContent = `Detail ${service.typeText}`;
            modalContent.innerHTML = '<div class="spinner"></div>';
            actionButtons.innerHTML = '';

            // Generate detail berdasarkan jenis layanan
            let html = '';
            switch (service.type) {
                case 'bantuan':
                    html = generateBantuanDetail(service.data);
                    break;
                case 'kk':
                    html = generateKKDetail(service.data);
                    break;
                case 'surat':
                    html = generateSuratDetail(service.data);
                    break;
                case 'pengaduan':
                    html = generatePengaduanDetail(service.data);
                    break;
            }

            // Tambahkan tombol aksi berdasarkan status
            if (service.status === 'pending') {
                const processBtn = document.createElement('button');
                processBtn.className = 'btn btn-primary';
                processBtn.innerHTML = '<i class="fas fa-check"></i> Proses';
                processBtn.onclick = () => updateServiceStatus(service, 'processed');
                actionButtons.appendChild(processBtn);

                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'btn btn-danger';
                rejectBtn.innerHTML = '<i class="fas fa-times"></i> Tolak';
                rejectBtn.onclick = () => updateServiceStatus(service, 'rejected');
                actionButtons.appendChild(rejectBtn);
            } else if (service.status === 'processed') {
                const completeBtn = document.createElement('button');
                completeBtn.className = 'btn btn-success';
                completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> Selesaikan';
                completeBtn.onclick = () => updateServiceStatus(service, 'completed');
                actionButtons.appendChild(completeBtn);
            }

            modalContent.innerHTML = html;
            modal.style.display = 'flex';
        }

        function generateBantuanDetail(data) {
            const date = new Date(data.timestamp);
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
        <div class="mb-3">
            <h4>Permohonan Bantuan Sosial</h4>
            <p class="text-muted"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
        </div>
        
        <div class="mb-3">
            <h5>Data Pemohon</h5>
            <p><strong>Nama:</strong> ${data.nama || '-'}</p>
            <p><strong>NIK:</strong> ${data.nik || '-'}</p>
            <p><strong>Alamat:</strong> ${data.alamat || '-'}</p>
        </div>
        
        <div class="mb-3">
            <h5>Detail Bantuan</h5>
            <p><strong>Jenis Bantuan:</strong> ${data.jenisBantuan || '-'}</p>
        </div>
    `;
        }

        function generateKKDetail(data) {
            const date = new Date(data.tanggal_pengajuan);
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let serviceDetail = '';
            switch (data.jenis_layanan) {
                case 'kk_baru':
                    serviceDetail = `
                <p><strong>Jenis Layanan:</strong> Pembuatan KK Baru</p>
                <p><strong>Surat Pengantar:</strong> ${data.surat_pengantar || '-'}</p>
            `;
                    break;
                case 'perubahan_data':
                    serviceDetail = `
                <p><strong>Jenis Layanan:</strong> Perubahan Data KK</p>
                <p><strong>Data yang Diubah:</strong> ${data.data_yang_diubah || '-'}</p>
                <p><strong>Alasan Perubahan:</strong> ${data.alasan_perubahan || '-'}</p>
            `;
                    break;
                case 'pemisahan_kk':
                    serviceDetail = `
                <p><strong>Jenis Layanan:</strong> Pemisahan KK</p>
                <p><strong>Nama Kepala Keluarga Baru:</strong> ${data.nama_kepala_keluarga_baru || '-'}</p>
                <p><strong>Anggota yang Dipisahkan:</strong> ${data.anggota_yang_dipisahkan || '-'}</p>
            `;
                    break;
                case 'penggantian_kk':
                    serviceDetail = `
                <p><strong>Jenis Layanan:</strong> Penggantian KK</p>
                <p><strong>Alasan Penggantian:</strong> ${data.alasan_penggantian || '-'}</p>
                ${data.surat_kehilangan ? `<p><strong>Surat Kehilangan:</strong> ${data.surat_kehilangan}</p>` : ''}
            `;
                    break;
                case 'penambahan_anggota':
                    serviceDetail = `
                <p><strong>Jenis Layanan:</strong> Penambahan Anggota Keluarga</p>
                <p><strong>Nama Anggota Baru:</strong> ${data.nama_anggota_baru || '-'}</p>
                <p><strong>Hubungan:</strong> ${data.hubungan_keluarga || '-'}</p>
                <p><strong>NIK Anggota Baru:</strong> ${data.nik_anggota_baru || '-'}</p>
            `;
                    break;
            }

            return `
        <div class="mb-3">
            <h4>Permohonan Kartu Keluarga</h4>
            <p class="text-muted"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
        </div>
        
        <div class="mb-3">
            <h5>Data Pemohon</h5>
            <p><strong>Nama Kepala Keluarga:</strong> ${data.nama_kepala_keluarga || '-'}</p>
            <p><strong>No. KK:</strong> ${data.no_kk || '-'}</p>
            <p><strong>Alamat:</strong> ${data.alamat || '-'}</p>
            <p><strong>RT/RW:</strong> ${data.rt_rw || '-'}</p>
            <p><strong>Kelurahan:</strong> ${data.kelurahan || '-'}</p>
            <p><strong>Kecamatan:</strong> ${data.kecamatan || '-'}</p>
            <p><strong>Kabupaten:</strong> ${data.kabupaten || '-'}</p>
            <p><strong>Provinsi:</strong> ${data.provinsi || '-'}</p>
            <p><strong>Kode Pos:</strong> ${data.kode_pos || '-'}</p>
        </div>
        
        <div class="mb-3">
            <h5>Detail Layanan</h5>
            ${serviceDetail}
        </div>
    `;
        }

        function generateSuratDetail(data) {
            const date = new Date(data.tanggal_pengajuan);
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            let serviceDetail = '';
            switch (data.jenis_surat) {
                case 'domisili':
                    serviceDetail = `
                <p><strong>Jenis Surat:</strong> Keterangan Domisili</p>
                <p><strong>Alamat Domisili:</strong> ${data.data_spesifik.alamat_domisili || '-'}</p>
                <p><strong>Lama Tinggal:</strong> ${data.data_spesifik.lama_tinggal || '-'} tahun</p>
            `;
                    break;
                case 'tidak_mampu':
                    serviceDetail = `
                <p><strong>Jenis Surat:</strong> Keterangan Tidak Mampu</p>
                <p><strong>Penghasilan:</strong> Rp ${data.data_spesifik.penghasilan || '-'}/bulan</p>
                <p><strong>Tanggungan Keluarga:</strong> ${data.data_spesifik.tanggungan || '-'} orang</p>
                <p><strong>Alasan:</strong> ${data.data_spesifik.alasan || '-'}</p>
            `;
                    break;
                case 'usaha':
                    serviceDetail = `
                <p><strong>Jenis Surat:</strong> Keterangan Usaha</p>
                <p><strong>Nama Usaha:</strong> ${data.data_spesifik.nama_usaha || '-'}</p>
                <p><strong>Jenis Usaha:</strong> ${data.data_spesifik.jenis_usaha || '-'}</p>
                <p><strong>Alamat Usaha:</strong> ${data.data_spesifik.alamat_usaha || '-'}</p>
                <p><strong>Lama Usaha:</strong> ${data.data_spesifik.lama_usaha || '-'} tahun</p>
            `;
                    break;
                case 'kematian':
                    serviceDetail = `
                <p><strong>Jenis Surat:</strong> Keterangan Kematian</p>
                <p><strong>Nama Almarhum/Almarhumah:</strong> ${data.data_spesifik.nama_alm || '-'}</p>
                <p><strong>Hubungan dengan Pemohon:</strong> ${data.data_spesifik.hubungan || '-'}</p>
                <p><strong>Tanggal Kematian:</strong> ${data.data_spesifik.tgl_kematian || '-'}</p>
                <p><strong>Tempat Kematian:</strong> ${data.data_spesifik.tempat_kematian || '-'}</p>
                <p><strong>Penyebab Kematian:</strong> ${data.data_spesifik.penyebab || '-'}</p>
            `;
                    break;
                case 'belum_menikah':
                    serviceDetail = `
                <p><strong>Jenis Surat:</strong> Keterangan Belum Menikah</p>
                <p><strong>Status Perkawinan:</strong> ${data.data_spesifik.status_kawin || '-'}</p>
            `;
                    break;
            }

            return `
        <div class="mb-3">
            <h4>Permohonan Surat Keterangan</h4>
            <p class="text-muted"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
        </div>
        
        <div class="mb-3">
            <h5>Data Pemohon</h5>
            <p><strong>Nama:</strong> ${data.data_pemohon.nama || '-'}</p>
            <p><strong>NIK:</strong> ${data.data_pemohon.nik || '-'}</p>
            <p><strong>Tempat/Tgl Lahir:</strong> ${data.data_pemohon.tempat_lahir || '-'}, ${data.data_pemohon.tanggal_lahir || '-'}</p>
            <p><strong>Jenis Kelamin:</strong> ${data.data_pemohon.jenis_kelamin || '-'}</p>
            <p><strong>Alamat:</strong> ${data.data_pemohon.alamat || '-'}</p>
            <p><strong>Pekerjaan:</strong> ${data.data_pemohon.pekerjaan || '-'}</p>
            <p><strong>Agama:</strong> ${data.data_pemohon.agama || '-'}</p>
            <p><strong>No. HP:</strong> ${data.data_pemohon.no_hp || '-'}</p>
        </div>
        
        <div class="mb-3">
            <h5>Detail Surat</h5>
            <p><strong>Keperluan:</strong> ${data.keperluan || '-'}</p>
            ${serviceDetail}
        </div>
    `;
        }

        function generatePengaduanDetail(data) {
            const date = new Date(data.timestamp);
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
        <div class="mb-3">
            <h4>Pengaduan Warga</h4>
            <p class="text-muted"><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
        </div>
        
        <div class="mb-3">
            <h5>Data Pengadu</h5>
            <p><strong>Nama:</strong> ${data.nama || 'Anonim'}</p>
            <p><strong>NIK:</strong> ${data.nik || '-'}</p>
        </div>
        
        <div class="mb-3">
            <h5>Isi Pengaduan</h5>
            <p><strong>Kategori:</strong> ${data.kategori || '-'}</p>
            <p>${data.deskripsi || '-'}</p>
        </div>
    `;
        }

        function updateServiceStatus(service, newStatus) {
            let ref;

            switch (service.type) {
                case 'bantuan':
                    ref = database.ref(`bantuan_sosial/${service.id}`);
                    break;
                case 'kk':
                    ref = database.ref(`kartu_keluarga/${service.id}`);
                    break;
                case 'surat':
                    ref = database.ref(`surat_keterangan/${service.id}`);
                    break;
                case 'pengaduan':
                    ref = database.ref(`pengaduan/${service.id}`);
                    break;
            }

            if (!ref) return;

            const updateData = {
                status: newStatus,
                processedAt: new Date().toISOString()
            };

            if (newStatus === 'completed') {
                const response = prompt('Masukkan catatan penyelesaian:');
                if (!response) return;
                updateData.response = response;
            } else if (newStatus === 'rejected') {
                const reason = prompt('Masukkan alasan penolakan:');
                if (!reason) return;
                updateData.rejectionReason = reason;
            }

            ref.update(updateData)
                .then(() => {
                    alert('Status layanan berhasil diperbarui');
                    document.getElementById('serviceModal').style.display = 'none';
                    loadServices();
                })
                .catch(error => {
                    console.error("Error updating service status:", error);
                    alert('Gagal memperbarui status layanan');
                });
        }// Add this to the section switching part
        if (section === 'services') {
            loadServices();
        }

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
    </script>
</body>

</html>